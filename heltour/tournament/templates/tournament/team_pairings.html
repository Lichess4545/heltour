{% extends "base.html" %}
{% load staticfiles tournament_extras %}

{% block title %}Pairings - {{ season.name }} - {{ league.name }}{% endblock %}

{% block nav_pairings %}active{% endblock %}

{% block js %}
<script>
var refreshInterval = 5 * 60 * 1000; // 5 minutes
var sleepBuffer = 5 * 1000; // 5 seconds
setTimeout(function () {
	setTimeout(function () { location.reload(); }, sleepBuffer);
}, refreshInterval - sleepBuffer);
</script>
{% endblock %}

{% block content %}
<div class="row row-condensed-xs pairings-row">
	<div class="col-md-12">
		<div class="well">
			<div class="well-head">
				<h3>Pairings</h3>
			</div>
			<div class="well-body">
				{% if round_number_list %}
				<div class="dropdown inline round-switcher">
					<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
						Round {{ round_number }}
					</button>
					<div class="dropdown-menu">
						{% for n in round_number_list %}
							{% if specified_team %}<a class="dropdown-item" href="{% leagueurl 'pairings_by_round_team' league.tag season.tag n current_team.number %}">Round {{ n }}</a>
							{% else %}<a class="dropdown-item" href="{% leagueurl 'pairings_by_round' league.tag season.tag n %}">Round {{ n }}</a>
							{% endif %}
						{% endfor %}
					</div>
				</div>
				{% endif %}
				{% if team_list %}
				<div class="dropdown inline round-switcher">
					<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
						{% if current_team %}{{ current_team.name }}{% else %}All Teams{% endif %}
					</button>
					<div class="dropdown-menu">
							{% if specified_round %}<a class="dropdown-item" href="{% leagueurl 'pairings_by_round' league.tag season.tag round_number %}">All Teams</a>
							{% else %}<a class="dropdown-item" href="{% leagueurl 'pairings' league.tag season.tag %}">All Teams</a>
							{% endif %}
						<div role="separator" class="dropdown-divider"></div>
						{% for team in team_list %}
							{% if specified_round %}<a class="dropdown-item" href="{% leagueurl 'pairings_by_round_team' league.tag season.tag round_number team.number %}">{{ team.name }}</a>
							{% else %}<a class="dropdown-item" href="{% leagueurl 'pairings_by_team' league.tag season.tag team.number %}">{{ team.name }}</a>
							{% endif %}
						{% endfor %}
					</div>
				</div>
				{% endif %}

				{% if pairing_lists %}
				<table class="table table-condensed-xs" id="table-team-pairings">
					{% for pairing_list in pairing_lists %}
					<tr class="header-row">
						{% with pairing_list.0.0.team_pairing as team_pairing %}
						<th>
							<a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag team_pairing.white_team.number %}">
								{{ team_pairing.white_team_name }}
							</a>
						</th>
						<th class="cell-score {% resultclass team_pairing.white_points team_pairing.black_points %}">
							{{ team_pairing.white_points_display|formatscore }}
						</th>
						<th class="cell-score {% resultclass team_pairing.black_points team_pairing.white_points %}">
							{{ team_pairing.black_points_display|formatscore }}
						</th>
						<th class="text-right">
							<a class="team-link" href="{% leagueurl 'team_profile' league.tag season.tag team_pairing.black_team.number %}">
								{{ team_pairing.black_team_name }}
							</a>
						</th>
						{% endwith %}
						<th class="cell-time table-menu">
							{% if forloop.counter == 1 %}
							<div class="dropdown">
								<a class="dropdown-toggle" data-toggle="dropdown">
									<span class="caret"></span>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									{% if current_team %}
									<a class="dropdown-item" href="webcal://{{ request.get_host }}{% leagueurl 'pairings_by_team_icalendar' league.tag season.tag current_team.number %}">Calendar</a>
									{% else %}
									<a class="dropdown-item" href="webcal://{{ request.get_host }}{% leagueurl 'pairings_icalendar' league.tag season.tag %}">Calendar</a>
									{% endif %}
								</div>
							</div>
							{% endif %}
						</th>{% if can_edit %}
						<th class="cell-edit">&nbsp;</th>{% endif %}
					</tr>
					{% for pairing, white_img, white_status, black_img, black_status in pairing_list %}
					<tr>
						<td class="pairing-player player-{{ pairing.white_team_color }}">
							{% if pairing.white_team_player %}
							<a class="download-games" href="https://lichess.org/api/games/user/{{ pairing.white_team_player.lichess_username }}?perfType={{ league.rating_type }}&color={{ pairing.white_team_color }}" target="_blank" rel="nofollow">
								<img src="{% static "tournament/img/download-icon.svg" %}">
							</a>
							<span class="color-dot left d-none d-sm-inline"></span>
							<a class="{% if pairing.white_team_player in unavailable_players %}player-unavailable" title="unavailable{% endif %}" href="{% leagueurl 'player_profile' league.tag season.tag pairing.white_team_player.lichess_username %}">
								{{ pairing.white_team_player.lichess_username }}<span class="d-inline d-sm-none"></span><span class="color-dot left d-inline d-sm-none"></span> ({% white_team_rating pairing %})
								{% if pairing.white_team_player in captains %}<span class="captain"></span>{% endif %}
							</a>
							{% if white_img %}
							<img src="{% static 'admin/img' %}/icon-{{ white_img }}.svg" title="{{ white_status }}" />
							{% endif %}
							{% endif %}
						</td>
						{% if pairing.game_link and not pairing.result %}
						<td class="cell-score" colspan="2">
							<a href="{{ pairing.game_link }}">&#x2694;</a>
						</td>
						{% else %}
						<td class="cell-game-result" colspan="2">
							{% if pairing.game_link %}
							<a href="{{ pairing.game_link }}">
							{% endif %}
							{% spaceless %}
							<span>
								{% if pairing.white_team_score != None %}
								{{ pairing.white_team_score|formatscore }}{% if not pairing.game_played %}{{ pairing.white_team_score|forfeitchar }}{% endif %}
								{% endif %}
							</span>
							<span>
								{% if pairing.black_team_score != None %}
								{{ pairing.black_team_score|formatscore }}{% if not pairing.game_played %}{{ pairing.black_team_score|forfeitchar }}{% endif %}
								{% endif %}
							</span>
							{% endspaceless %}
							{% if pairing.game_link %}
							</a>
							{% endif %}
						</td>
						{% endif %}
						<td class="text-right pairing-player player-{{ pairing.black_team_color }}">
							{% if pairing.black_team_player %}
							{% if black_img %}
							<img src="{% static 'admin/img' %}/icon-{{ black_img }}.svg" title="{{ black_status }}" />
							{% endif %}
							<a class="{% if pairing.black_team_player in unavailable_players %}player-unavailable" title="unavailable{% endif %}" href="{% leagueurl 'player_profile' league.tag season.tag pairing.black_team_player.lichess_username %}">
								{{ pairing.black_team_player.lichess_username }} <span class="d-inline d-sm-none"></span> ({% black_team_rating pairing %})
								{% if pairing.black_team_player in captains %}<span class="captain"></span>{% endif %}
							</a>
							<span class="color-dot right"></span>
							<a class="download-games" href="https://lichess.org/api/games/user/{{ pairing.black_team_player.lichess_username }}?perfType={{ league.rating_type }}&color={{ pairing.black_team_color }}" target="_blank" rel="nofollow">
								<img src="{% static "tournament/img/download-icon.svg" %}">
							</a>
							{% endif %}
						</td>
						<td class="text-right cell-time">{{ pairing.scheduled_time | date_el:"m/d H:i" }}</td>{% if can_edit %}
						<td class="cell-edit">
							<a href="{% url 'admin:tournament_playerpairing_change' pairing.pk %}?_popup=1" id="change-pairing-{{ pairing.pk }}" class="popup-link" title="Change selected pairing">
								<img src="{% static 'admin/img/icon-changelink.svg' %}" alt="Change">
							</a>
						</td>{% endif %}
					</tr>
					{% endfor %}
					{% endfor %}
				</table>
				{% if show_legend %}
				<table>
					<tr>
						<td class="legend-swatch player-unavailable"></td>
						<td class="legend-label">Unavailable</td>
					</tr>
				</table>
				{% endif %}
				{% else %}
				<p>No pairings available.</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}
